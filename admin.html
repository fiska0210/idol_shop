<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†åº—å¾Œå°ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCNWQsi4aEcBvegrz96XqtzTJ_1p992i7A",
            authDomain: "kabushikigaisha.firebaseapp.com",
            projectId: "kabushikigaisha",
            storageBucket: "kabushikigaisha.firebasestorage.app",
            messagingSenderId: "1020713787146",
            appId: "1:1020713787146:web:87c1800c0eb1e730dce4f3",
            measurementId: "G-BZZNNJK117"
        };

        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.firebaseMethods = { signInWithEmailAndPassword, onAuthStateChanged, signOut, collection, getDocs, addDoc, doc, updateDoc, deleteDoc, query, orderBy };
    </script>
</head>
<body class="bg-gray-100 min-h-screen">

<div id="adminApp" class="container mx-auto p-4 max-w-4xl">
    
    <!-- 1. ç™»å…¥ç•«é¢ -->
    <div v-if="!user" class="max-w-md mx-auto bg-white p-8 rounded shadow mt-20">
        <h2 class="text-2xl font-bold mb-4 text-center">å¾Œå°ç™»å…¥</h2>
        <input v-model="loginData.email" type="email" placeholder="Email" class="w-full border p-2 mb-3 rounded">
        <input v-model="loginData.password" type="password" placeholder="Password" class="w-full border p-2 mb-4 rounded">
        <button @click="login" class="w-full bg-blue-600 text-white py-2 rounded font-bold">ç™»å…¥</button>
    </div>

    <!-- 2. ç®¡ç†ä»‹é¢ -->
    <div v-else>
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">ğŸ”§ å•†åº—å¾Œå°</h1>
            <button @click="logout" class="text-red-500 underline">ç™»å‡º</button>
        </div>

        <!-- é ç±¤åˆ‡æ› -->
        <div class="flex space-x-4 mb-6">
            <button @click="currentTab = 'products'" :class="currentTab === 'products' ? 'bg-blue-600 text-white' : 'bg-white'" class="px-4 py-2 rounded shadow">å•†å“ç®¡ç†</button>
            <button @click="currentTab = 'orders'" :class="currentTab === 'orders' ? 'bg-blue-600 text-white' : 'bg-white'" class="px-4 py-2 rounded shadow">è¨‚å–®ç®¡ç†</button>
        </div>

        <!-- å•†å“ç®¡ç†å€å¡Š -->
        <div v-if="currentTab === 'products'">
            <!-- æ–°å¢å•†å“è¡¨å–® -->
            <div class="bg-white p-4 rounded shadow mb-6">
                <h3 class="font-bold mb-3">æ–°å¢å•†å“</h3>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input v-model="newProduct.name" placeholder="å•†å“åç¨±" class="border p-2 rounded">
                    <input v-model.number="newProduct.price" type="number" placeholder="åƒ¹æ ¼" class="border p-2 rounded">
                    <select v-model="newProduct.category" class="border p-2 rounded">
                        <option value="concert">æ¼”å”±æœƒ</option>
                        <option value="fanmeet">è¦‹é¢æœƒ</option>
                        <option value="album">å°ˆè¼¯</option>
                    </select>
                    <input v-model="newProduct.image" placeholder="åœ–ç‰‡ç¶²å€ (https://...)" class="border p-2 rounded">
                </div>
                <button @click="addProduct" class="bg-green-600 text-white px-4 py-2 rounded">æ–°å¢ä¸Šæ¶</button>
            </div>

            <!-- å•†å“åˆ—è¡¨ -->
            <div class="grid gap-4">
                <div v-for="p in products" :key="p.id" class="bg-white p-4 rounded shadow flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <img :src="p.image" class="w-12 h-12 object-cover bg-gray-200 rounded">
                        <div>
                            <div class="font-bold">{{ p.name }}</div>
                            <div class="text-sm text-gray-500">${{ p.price }} | {{ p.category }}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="toggleStatus(p)" :class="p.status === 'on' ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-500'" class="px-3 py-1 rounded text-sm font-bold">
                            {{ p.status === 'on' ? 'ä¸Šæ¶ä¸­' : 'å·²ä¸‹æ¶' }}
                        </button>
                        <button @click="deleteProduct(p.id)" class="bg-red-100 text-red-600 px-3 py-1 rounded text-sm">åˆªé™¤</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¨‚å–®ç®¡ç†å€å¡Š -->
        <div v-if="currentTab === 'orders'">
            <button @click="fetchOrders" class="mb-4 text-blue-600 underline">é‡æ–°æ•´ç†åˆ—è¡¨</button>
            <div v-if="orders.length === 0" class="text-gray-500">ç›®å‰æ²’æœ‰è¨‚å–®</div>
            <div v-for="order in orders" :key="order.id" class="bg-white p-4 rounded shadow mb-4 border-l-4 border-blue-500">
                <div class="flex justify-between mb-2">
                    <span class="font-bold text-lg">{{ order.customer.name }} ({{ order.customer.phone }})</span>
                    <span class="text-gray-500 text-sm">{{ new Date(order.createdAt).toLocaleString() }}</span>
                </div>
                <div class="text-sm text-gray-600 mb-2">åœ°å€: {{ order.customer.address }}</div>
                <div class="bg-gray-50 p-2 rounded mb-2">
                    <div v-for="item in order.items" class="flex justify-between text-sm">
                        <span>{{ item.name }}</span>
                        <span>${{ item.price }}</span>
                    </div>
                    <div class="border-t mt-1 pt-1 flex justify-between font-bold">
                        <span>ç¸½è¨ˆ</span>
                        <span>${{ order.total }}</span>
                    </div>
                </div>
                <div class="text-right">
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-sm">ç‹€æ…‹: {{ order.status }}</span>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    setTimeout(() => {
        const { createApp } = Vue;
        const { signInWithEmailAndPassword, onAuthStateChanged, signOut, collection, getDocs, addDoc, doc, updateDoc, deleteDoc, query, orderBy } = window.firebaseMethods;

        createApp({
            data() {
                return {
                    user: null,
                    loginData: { email: '', password: '' },
                    currentTab: 'products',
                    products: [],
                    orders: [],
                    newProduct: { name: '', price: '', category: 'concert', image: 'https://placehold.co/400', status: 'on' }
                }
            },
            methods: {
                login() {
                    signInWithEmailAndPassword(window.auth, this.loginData.email, this.loginData.password)
                        .then(u => this.user = u.user)
                        .catch(e => alert("ç™»å…¥å¤±æ•—: " + e.message));
                },
                logout() {
                    signOut(window.auth).then(() => this.user = null);
                },
                async fetchProducts() {
                    const q = query(collection(window.db, "products"));
                    const snap = await getDocs(q);
                    this.products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                },
                async addProduct() {
                    if(!this.newProduct.name) return;
                    await addDoc(collection(window.db, "products"), this.newProduct);
                    this.newProduct.name = ''; // æ¸…ç©º
                    this.fetchProducts(); // é‡æ–°è®€å–
                },
                async toggleStatus(p) {
                    const newStatus = p.status === 'on' ? 'off' : 'on';
                    await updateDoc(doc(window.db, "products", p.id), { status: newStatus });
                    p.status = newStatus; // æœ¬åœ°æ›´æ–°UI
                },
                async deleteProduct(id) {
                    if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                        await deleteDoc(doc(window.db, "products", id));
                        this.fetchProducts();
                    }
                },
                async fetchOrders() {
                    // è¨‚å–®é€šå¸¸æƒ³çœ‹æœ€æ–°çš„ï¼Œæ‰€ä»¥ orderBy createdAt desc
                    const q = query(collection(window.db, "orders"), orderBy("createdAt", "desc"));
                    const snap = await getDocs(q);
                    this.orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                }
            },
            mounted() {
                // ç›£è½ç™»å…¥ç‹€æ…‹
                onAuthStateChanged(window.auth, (u) => {
                    this.user = u;
                    if (u) {
                        this.fetchProducts();
                        this.fetchOrders();
                    }
                });
            }
        }).mount('#adminApp');
    }, 1000);
</script>
</body>
</html>