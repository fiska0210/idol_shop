<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¶åƒå‘¨é‚Šå•†åº— PWA</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Firebase SDK (æ¨¡çµ„åŒ–ç‰ˆæœ¬) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCNWQsi4aEcBvegrz96XqtzTJ_1p992i7A",
            authDomain: "kabushikigaisha.firebaseapp.com",
            projectId: "kabushikigaisha",
            storageBucket: "kabushikigaisha.firebasestorage.app",
            messagingSenderId: "1020713787146",
            appId: "1:1020713787146:web:87c1800c0eb1e730dce4f3",
            measurementId: "G-BZZNNJK117"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // å°‡ db æ›è¼‰åˆ° window ä»¥ä¾¿ Vue ä½¿ç”¨
        window.db = db;
        window.dbMethods = { collection, getDocs, addDoc, query, where, orderBy };
    </script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans pb-20">

<div id="app">
    <!-- Header -->
    <header class="bg-pink-600 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
        <h1 class="text-xl font-bold">ğŸŒŸ å¶åƒå‘¨é‚Šå•†åº—</h1>
        <button @click="showCart = true" class="relative p-2">
            ğŸ›’ <span v-if="cart.length > 0" class="absolute top-0 right-0 bg-yellow-400 text-pink-800 text-xs font-bold px-1 rounded-full">{{ cart.length }}</span>
        </button>
    </header>

    <!-- Theme Nav -->
    <nav class="flex overflow-x-auto whitespace-nowrap py-4 px-4 space-x-4 no-scrollbar">
        <button v-for="theme in themes" :key="theme.id" @click="currentCategory = theme.id"
            :class="currentCategory === theme.id ? 'bg-pink-600 text-white shadow-lg' : 'bg-white text-gray-600 border'"
            class="px-6 py-2 rounded-full transition-all font-medium flex-shrink-0">
            {{ theme.name }}
        </button>
    </nav>

    <!-- Products -->
    <main class="container mx-auto px-4">
        <div v-if="isLoading" class="text-center py-10">è¼‰å…¥ä¸­...</div>
        <div v-else class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <div v-for="product in filteredProducts" :key="product.id" class="bg-white rounded-xl shadow-sm overflow-hidden flex flex-col">
                <img :src="product.image" class="w-full h-40 object-cover bg-gray-200">
                <div class="p-3 flex flex-col flex-grow">
                    <h3 class="font-medium line-clamp-2 mb-1">{{ product.name }}</h3>
                    <div class="mt-auto flex justify-between items-center">
                        <span class="text-lg font-bold">${{ product.price }}</span>
                        <button @click="addToCart(product)" class="bg-gray-900 text-white p-2 rounded-full text-xs">åŠ å…¥</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Cart Modal & Checkout Form -->
    <div v-if="showCart" class="fixed inset-0 z-50 flex justify-end bg-black/50 backdrop-blur-sm">
        <div class="w-full max-w-md bg-white h-full flex flex-col p-4 overflow-y-auto">
            <div class="flex justify-between border-b pb-2 mb-2">
                <h2 class="text-lg font-bold">è³¼ç‰©è»Š</h2>
                <button @click="showCart = false">âœ•</button>
            </div>
            
            <div v-for="(item, index) in cart" class="flex justify-between items-center mb-4 bg-gray-50 p-2 rounded">
                <div>
                    <div class="font-bold">{{ item.name }}</div>
                    <div class="text-pink-600">${{ item.price }}</div>
                </div>
                <button @click="cart.splice(index, 1)" class="text-red-500">åˆªé™¤</button>
            </div>

            <div class="mt-auto pt-4 border-t">
                <div class="flex justify-between text-xl font-bold mb-4">
                    <span>ç¸½è¨ˆ</span><span>${{ cartTotal }}</span>
                </div>
                
                <!-- é¡§å®¢è³‡æ–™å¡«å¯«å€ -->
                <div class="space-y-3 mb-4">
                    <input v-model="customer.name" placeholder="å§“å" class="w-full border p-2 rounded">
                    <input v-model="customer.phone" placeholder="é›»è©±" class="w-full border p-2 rounded">
                    <input v-model="customer.address" placeholder="åœ°å€" class="w-full border p-2 rounded">
                </div>

                <button @click="submitOrder" :disabled="isSubmitting" class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold disabled:bg-gray-400">
                    {{ isSubmitting ? 'é€å‡ºä¸­...' : 'ç¢ºèªä¸‹å–®' }}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // ç­‰å¾… Firebase è¼‰å…¥
    setTimeout(() => {
        const { createApp } = Vue;
        const { collection, getDocs, addDoc, query, where } = window.dbMethods;

        createApp({
            data() {
                return {
                    currentCategory: 'concert',
                    showCart: false,
                    cart: [],
                    products: [],
                    isLoading: true,
                    isSubmitting: false,
                    themes: [
                        { id: 'concert', name: 'ğŸ¤ æ¼”å”±æœƒ', title: 'Concert' },
                        { id: 'fanmeet', name: 'ğŸ¤ è¦‹é¢æœƒ', title: 'Fanmeeting' },
                        { id: 'album', name: 'ğŸ’¿ å°ˆè¼¯', title: 'Album' }
                    ],
                    customer: { name: '', phone: '', address: '' }
                }
            },
            computed: {
                filteredProducts() { return this.products.filter(p => p.category === this.currentCategory); },
                cartTotal() { return this.cart.reduce((sum, item) => sum + item.price, 0); }
            },
            methods: {
                addToCart(p) { this.cart.push(p); },
                
                async fetchProducts() {
                    this.isLoading = true;
                    try {
                        // åªè®€å–ç‹€æ…‹ç‚º 'on' çš„å•†å“
                        const q = query(collection(window.db, "products"), where("status", "==", "on"));
                        const querySnapshot = await getDocs(q);
                        this.products = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } catch (e) {
                        console.error("Error", e);
                        alert("ç„¡æ³•è®€å–å•†å“ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                    }
                    this.isLoading = false;
                },

                async submitOrder() {
                    if (this.cart.length === 0) return alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
                    if (!this.customer.name || !this.customer.phone) return alert('è«‹å¡«å¯«å§“åèˆ‡é›»è©±');

                    this.isSubmitting = true;
                    try {
                        await addDoc(collection(window.db, "orders"), {
                            items: this.cart,
                            total: this.cartTotal,
                            customer: this.customer,
                            status: 'pending', // è¨‚å–®ç‹€æ…‹ï¼šå¾…è™•ç†
                            createdAt: new Date().toISOString()
                        });
                        alert('è¨‚å–®å·²é€å‡ºï¼è¬è¬è³¼è²·ï¼');
                        this.cart = [];
                        this.showCart = false;
                    } catch (e) {
                        console.error("Order Error", e);
                        alert("ä¸‹å–®å¤±æ•—");
                    }
                    this.isSubmitting = false;
                }
            },
            mounted() {
                this.fetchProducts();
            }
        }).mount('#app');
    }, 1000); // ç°¡å–®å»¶é²ç¢ºä¿ module è¼‰å…¥ï¼Œæ­£å¼ç’°å¢ƒå¯ç”¨ better loader
</script>
</body>
</html>